# è·¨æµè§ˆå™¨æ’ä»¶æ¶æ„æ–¹æ¡ˆ (Chrome + Firefox)

> [!TIP]
> **æ ¸å¿ƒæ¨è**: ä½¿ç”¨ **Plasmo Framework**ã€‚è¿™æ˜¯ç›®å‰å¼€å‘æµè§ˆå™¨æ’ä»¶çš„ "Next.js"ï¼Œå®Œç¾æ”¯æŒ Reactï¼Œå¹¶ä¸”èƒ½è‡ªåŠ¨å¤„ç† Chrome (Manifest V3) å’Œ Firefox ä¹‹é—´çš„å…¼å®¹æ€§å·®å¼‚ã€‚ä¸€å¥—ä»£ç ï¼Œå¤šå¤„è¿è¡Œã€‚

## 1. ä¸ºä»€ä¹ˆé€‰æ‹© Plasmo?

ä¼ ç»Ÿçš„æ’ä»¶å¼€å‘éœ€è¦åœ¨ `webpack/vite` ä¸­æ‰‹åŠ¨é…ç½®å¾ˆå¤šå¤æ‚çš„å…¥å£ (Popup, Content Script, Background)ï¼Œè¿˜è¦æ‰‹åŠ¨å¤„ç† Manifest æ–‡ä»¶çš„ç‰ˆæœ¬å·®å¼‚ (Chrome å¼ºåˆ¶ V3ï¼ŒFirefox è™½ç„¶æ”¯æŒ V3 ä½†æœ‰äº› API ä¸åŒ)ã€‚

**Plasmo çš„ä¼˜åŠ¿**:
*   **React + TypeScript ä¸€ç­‰å…¬æ°‘**: å¼€ç®±å³ç”¨ï¼Œä½“éªŒå’Œå†™ Next.js å‡ ä¹ä¸€æ ·ã€‚
*   **è‡ªåŠ¨è·¨æµè§ˆå™¨æ„å»º**: è¿è¡Œ `pnpm build --target=firefox-mv2` æˆ– `pnpm build --target=chrome-mv3` å³å¯è‡ªåŠ¨ç”Ÿæˆå¯¹åº”å®‰è£…åŒ…ã€‚
*   **çƒ­é‡è½½ (HMR)**: ä¿®æ”¹ React ç»„ä»¶ï¼Œæµè§ˆå™¨é‡Œçš„æ’ä»¶ç•Œé¢å®æ—¶æ›´æ–°ï¼Œå¼€å‘ä½“éªŒæä½³ã€‚

## 2. æ¶æ„è®¾è®¡ (MVP)

### ğŸ“‚ ç›®å½•ç»“æ„ (Plasmo é£æ ¼)
```text
src/
â”œâ”€â”€ background/
â”‚   â”œâ”€â”€ index.ts         # åå°å…¥å£
â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”œâ”€â”€ openai.ts    # OpenAI é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ gemini.ts    # Gemini é€‚é…å™¨ (æ–°å¢)
â”‚   â”‚   â””â”€â”€ index.ts     # ç»Ÿä¸€æ¥å£ç­–ç•¥æ¨¡å¼
â”œâ”€â”€ content.ts           # æ³¨å…¥è„šæœ¬
â”œâ”€â”€ popup.tsx            # ç®€å•çŠ¶æ€æ˜¾ç¤º
â”œâ”€â”€ options.tsx          # è¯¦ç»†è®¾ç½®é¡µ (Promptç¼–è¾‘/API Keyè®¾ç½®)
â”œâ”€â”€ components/          # React UI ç»„ä»¶
â””â”€â”€ style.css            # Tailwind / CSS
```

### ğŸ§© æ ¸å¿ƒæµç¨‹æ›´æ–°
1.  **å¤šé¡µé¢æ³¨å…¥ (Content Script)**:
    *   **Review é¡µ**: (`https://review.rms.rakuten.co.jp/*`)
        *   æ³¨å…¥ `<AIReviewButton />`ã€‚
        *   ä¸Šä¸‹æ–‡æŠ“å–ï¼šè¯„è®ºå†…å®¹ã€è¯„åˆ†ã€å•†å“åã€‚
    *   **Inquiry (R-Messe) é¡µ**: (`https://rmesse.rms.rakuten.co.jp/*`)
        *   æ³¨å…¥ `<AIInquiryButton />`ã€‚
        *   ä¸Šä¸‹æ–‡æŠ“å–ï¼šä¹°å®¶å’¨è¯¢å†…å®¹ã€å†å²å¯¹è¯ã€‚
2.  **æ™ºèƒ½åœºæ™¯è¯†åˆ«**:
    *   æ’ä»¶æ ¹æ® URL è‡ªåŠ¨åˆ¤æ–­å½“å‰æ˜¯ "Review" æ¨¡å¼è¿˜æ˜¯ "Inquiry" æ¨¡å¼ã€‚
    *   **åŠ è½½å¯¹åº”çš„ Prompt**:
        *   Review æ¨¡å¼ -> ä½¿ç”¨ `review_prompt`ã€‚
        *   Inquiry æ¨¡å¼ -> ä½¿ç”¨ `inquiry_prompt`ã€‚
3.  **è·å–é…ç½® (Storage)**:
    *   è¯»å–ç”¨æˆ·è®¾ç½®ï¼š`provider`, `apiKey`, `customPrompts` (åŒ…å« review å’Œ inquiry ä¸¤ä¸ªæ¨¡æ¿)ã€‚
3.  **æ„å»º Prompt**:
    *   å°† `{{review_text}}`, `{{product_name}}` ç­‰å˜é‡æ›¿æ¢åˆ° Prompt æ¨¡æ¿ä¸­ã€‚
4.  **è°ƒç”¨ AI (Background Script)**:
    *   Content Script å‘é€æ¶ˆæ¯ `generateReply`ã€‚
    *   Background æ ¹æ® `provider` é€‰æ‹©å¯¹åº”çš„é€‚é…å™¨ (`OpenAIAdapter` æˆ– `GeminiAdapter`) æ‰§è¡Œè¯·æ±‚ã€‚

## 3. æ–°å¢åŠŸèƒ½æ¨¡å—è®¾è®¡

### ğŸ¤– å¤šæ¨¡å‹æ”¯æŒ (Multi-LLM)
*   **æŠ½è±¡å±‚**: å®šä¹‰ä¸€ä¸ªç»Ÿä¸€æ¥å£ `LLMService`ã€‚
    ```typescript
    interface LLMService {
      generateReply(prompt: string, context: ReviewContext): Promise<string>;
    }
    ```
*   **Gemini å®ç°**: ä½¿ç”¨ Google Generative AI SDK (æ³¨æ„ï¼šåœ¨æµè§ˆå™¨ç¯å¢ƒå¯èƒ½éœ€è¦ fetch å…¼å®¹å¤„ç†ï¼Œæˆ–è€…ç›´æ¥ç”¨ REST API)ã€‚
*   **OpenAI å®ç°**: ä½¿ç”¨æ ‡å‡† OpenAI SDKã€‚

### ğŸ“ æç¤ºè¯ç®¡ç† (Prompt Manager)
*   **è®¾ç½®é¡µé¢**: æä¾›**ä¸¤ä¸ª**ç‹¬ç«‹çš„ç¼–è¾‘æ¡†ã€‚
    1.  **Review Reply Prompt**: é’ˆå¯¹å•†å“è¯„ä»·çš„å›å¤ã€‚
    2.  **Inquiry Reply Prompt**: é’ˆå¯¹ R-Messe å’¨è¯¢çš„å›å¤ã€‚
*   **æ™ºèƒ½åˆ‡æ¢**: åœ¨ä¸åŒé¡µé¢é€šè¿‡ `storage` è¯»å–å¯¹åº”çš„ Promptã€‚

## 5. ç™»å½•éªŒè¯ä¸æƒé™ (Authentication)

ç”¨æˆ·æåˆ°äº† "ä¸ç™»å½•æ— æ³•æŸ¥çœ‹é¡µé¢" çš„éš¾ç‚¹ã€‚

**æ‰©å±•ç¨‹åºçš„å¤©ç„¶ä¼˜åŠ¿**:
*   æ‰©å±•ç¨‹åº (Extension) **å…±äº«ä¸»æµè§ˆå™¨çš„ Cookie å’Œ Session**ã€‚
*   **è§£å†³æ–¹æ¡ˆ**:
    *   **æ— éœ€åšæ¨¡æ‹Ÿç™»å½•åŠŸèƒ½**ï¼šæˆ‘ä»¬ä¸éœ€è¦åƒ Python è„šæœ¬é‚£æ ·å»å¤„ç†å¤æ‚çš„éªŒè¯ç ã€2FA ç™»å½•ã€‚
    *   **ä¾èµ–ç”¨æˆ·æ‰‹åŠ¨ç™»å½•**ï¼šç”¨æˆ·åªéœ€åƒå¾€å¸¸ä¸€æ ·åœ¨æµè§ˆå™¨ç™»å½• Rakuten RMSã€‚
    *   **çŠ¶æ€æ£€æµ‹**: æ’ä»¶å¯åŠ¨æ—¶æ£€æµ‹å½“å‰é¡µé¢æ˜¯å¦æœ‰ç‰¹å®šå…ƒç´ ï¼ˆä¾‹å¦‚ "Login" æŒ‰é’®ï¼‰ã€‚
        *   å¦‚æœæ£€æµ‹åˆ°æœªç™»å½• -> å¼¹å‡ºæç¤º "è¯·å…ˆç™»å½• RMS"ã€‚
        *   å¦‚æœæ£€æµ‹åˆ°å·²ç™»å½• -> æ­£å¸¸æ˜¾ç¤º AI æŒ‰é’®ã€‚
    *   **å®‰å…¨æ€§**: ä¸æ¥è§¦ç”¨æˆ·çš„å¯†ç ï¼Œæå¤§é™ä½å®‰å…¨é£é™©ã€‚

## 6. å…¼å®¹æ€§æ–¹æ¡ˆ (Chrome vs Firefox)

è™½ç„¶ Chrome å’Œ Firefox çš„å†…æ ¸ä¸åŒï¼Œä½† Plasmo ä¼šå¸®ä½ æŠ¹å¹³ 95% çš„å·®å¼‚ã€‚æˆ‘ä»¬éœ€è¦æ³¨æ„çš„å‰©ä¸‹ 5%ï¼š

| åŠŸèƒ½ | Chrome (V3) | Firefox (V2/V3) | Plasmo è§£å†³æ–¹æ¡ˆ |
| :--- | :--- | :--- | :--- |
| **åå°è¿è¡Œ** | Service Worker (ä¼šä¼‘çœ ) | Background Page (æŒä¹…) | Plasmo ä¼šæ ¹æ® target è‡ªåŠ¨ç¼–è¯‘æˆæ­£ç¡®çš„æ–‡ä»¶ |
| **API å‘½å** | `chrome.*` | `browser.*` | éƒ½å¯ä»¥ç”¨ï¼Œå»ºè®®å®‰è£… `@types/chrome`ï¼ŒFirefox ä¹Ÿå…¼å®¹ `chrome.*` å‘½åç©ºé—´ |
| **æƒé™** | ä¸¥æ ¼é™åˆ¶è¿œç¨‹ä»£ç  | ç›¸å¯¹å®½æ¾ | åœ¨ `package.json` çš„ manifest å­—æ®µç»Ÿä¸€å£°æ˜ï¼ŒPlasmo è‡ªåŠ¨å¤„ç† |

## 4. MVP å¼€å‘æ­¥éª¤

1.  **åˆå§‹åŒ–**:
    ```bash
    pnpm create plasmo --with-react
    ```
2.  **é…ç½®æƒé™**:
    åœ¨ `package.json` æ·»åŠ ï¼š
    ```json
    "manifest": {
      "permissions": ["storage", "activeTab", "scripting"],
      "host_permissions": ["https://api.openai.com/*", "https://*.rakuten.co.jp/*"]
    }
    ```
3.  **ç¼–å†™æ ¸å¿ƒé€»è¾‘**:
    *   `content.ts`: è´Ÿè´£ DOM æ“ä½œ (æŠ“å– + å¡«å…¥)ã€‚
    *   `background.ts`: è´Ÿè´£ç½‘ç»œè¯·æ±‚ (fetch OpenAI)ã€‚

## 5. Firefox ç‰¹åˆ«æ³¨æ„äº‹é¡¹

Firefox å¯¹æ’ä»¶çš„å®¡æ ¸æ¯”è¾ƒä¸¥æ ¼ï¼ˆå¦‚æœå‘å¸ƒåˆ°å•†åº—ï¼‰ã€‚å¦‚æœæ˜¯**è‡ªå·±åŠ è½½** (Load Temporary Add-on)ï¼š
1.  ä¸éœ€è¦ç­¾åã€‚
2.  ç›´æ¥åœ¨ `about:debugging` -> `This Firefox` -> `Load Temporary Add-on` é€‰æ‹©æ„å»ºå¥½çš„ `manifest.json` å³å¯ã€‚
3.  **Firefox Container**: å¦‚æœä½ ç”¨äº† Firefox çš„ Container æ’ä»¶ï¼ŒPlasmo å¼€å‘çš„æ’ä»¶é»˜è®¤å¯ä»¥åœ¨æ‰€æœ‰ Container è¿è¡Œï¼Œéå¸¸é€‚åˆä½ çš„å¤šåº—é“ºç®¡ç†éœ€æ±‚ã€‚

**æ€»ç»“**:
ç”¨ **Plasmo** + **React**ï¼Œè¿™æ˜¯ç›®å‰æœ€å¿«ã€æœ€ç¨³çš„æ–¹æ¡ˆã€‚ä¸éœ€è¦ä¸ºäº†å¤šæµè§ˆå™¨ç»´æŠ¤ä¸¤ä»½ä»£ç ã€‚
